@using Microsoft.AspNet.Identity
@{
    ViewBag.Title = "Contact";
}
<h2>@ViewBag.Title.</h2>
<h3>@ViewBag.Message</h3>
<h2>Podłoczonych użytkowników: <span id="clientsNumber">0</span></h2>

<div class="row">
    <div class="col-md-6">
    <canvas id="canvas" width="500" height="300"
            style="border: 1px gainsboro dashed"></canvas>
        <input type="button" class="btn btn-danger "
               id="clear-btn" value="Clear"/>
        </div>
    <div class="col-md-6">

        <textarea readonly="readonly" class="form-control" style="height: 230px"></textarea>
        <input type="text" id="chat-text" class="form-control form-inline"/>
        <input type="button" value="Send!"  class="btn btn-default form-control form-inline" id="send-btn"/>
        <label id="alert"></label>
    </div>
</div>
@section scripts
{

    <script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.6.6/fabric.min.js"></script>

    <script>
        var drawPath;
        var initialiseCanvas = function() {

            document.puneCanvas = new fabric.Canvas('canvas');

            document.puneCanvas.isDrawingMode = true;

            var pathCreated = function(e) {
                console.log(e.path);
                $.connection.puns.server
                    .sendPath(JSON.stringify(e.path));
            };
            document.puneCanvas.loadPath = pathCreated;
            document.puneCanvas.on({
                'path:created': pathCreated
            });

            $("#clear-btn")
                .click(function() {
                    $.connection.puns.server.clear();
                });      
        }

        function alertMessage() {
            var go = true;
           if (@Html.Raw(Json.Encode(User.Identity.IsAuthenticated)) === false) {
               alert("You have to log in!");
               go = false;
           }
            else if($("#chat-text").val() ==="") {
                alert("You have to write something");
                go = false;
            }
            return go;
        }

        $("#send-btn")
              .click(function () {
                  if(alertMessage() === true)
                  {
                  var msg = $("#chat-text").val();
                  $.connection.chat.server.sendToAll(msg);
                  $("#chat-text").val("");
                    }
              });

        drawPath = function(pathString) {
            var path = JSON.parse(pathString);
            fabric.util.enlivenObjects([path],
                function(objects) {
                    objects.forEach(function(o) {
                        document.puneCanvas.add(o);
                    });
                });
        }

        $.connection.puns.client.clear = function() {
            document.puneCanvas.clear();
        }


        $.connection.chat.client.hello = function(msg) {
            $("textarea").append(msg + "\n");

        }

        $.connection.puns.client.loadImage = function(paths) {
            initialiseCanvas();
            for (var i = 0; i < paths.length; i++) {
                drawPath(paths[i]);
            }
        }

        $.connection.puns.client.drawPath = drawPath;
        $.connection.puns.client.updateNumberOfClients = function(numberOfClients) {
            $("#clientsNumber").text(numberOfClients);
        }
        $.connection.hub.start();


    </script>
}
